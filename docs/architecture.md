# netlify-okta-auth Architecture

Okta supports OpenID Connect, which is JWT-based, utilizing an RS256 encoded token.

Netlify, on the other hand, [supports access control](https://docs.netlify.com/visitor-access/role-based-access-control/) via JWT, but only supports HS256 encoding. The recommended solution from Netlify is to create a Netlify-hosted function that Okta posts its RS256 token to and then have the function validate the token and then issue a new HS256 token. This package takes care of all that for you.

This diagram shows the flow where the user starts on your Okta portal and clicks on the tile for your website.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gICAgcGFydGljaXBhbnQgTyBhcyBPa3RhXG4gICAgcGFydGljaXBhbnQgTiBhcyBOZXRsaWZ5XG4gICAgcGFydGljaXBhbnQgQiBhcyBCcm93c2VyXG4gICAgTy0-Pk46IFBPU1QgUlMyNTYgSldUXG4gICAgTi0-PkI6IG5mX2p3dCBjb29raWUgKEhTMjU2IEpXVClcbiAgICBOLT4-QjogMzAyIHJlZGlyZWN0IHRvIGRvY3MgaG9tZSAvXG4gICAgQi0tPj5OOiBHRVQgLyAod2l0aCBuZl9qd3QgY29va2llKVxuICAgIE4tLT4-QjogWWVwLCB5b3UncmUgYXV0aG9yaXplZCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/edit/#eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gICAgcGFydGljaXBhbnQgTyBhcyBPa3RhXG4gICAgcGFydGljaXBhbnQgTiBhcyBOZXRsaWZ5XG4gICAgcGFydGljaXBhbnQgQiBhcyBCcm93c2VyXG4gICAgTy0-Pk46IFBPU1QgUlMyNTYgSldUXG4gICAgTi0-PkI6IG5mX2p3dCBjb29raWUgKEhTMjU2IEpXVClcbiAgICBOLT4-QjogMzAyIHJlZGlyZWN0IHRvIGRvY3MgaG9tZSAvXG4gICAgQi0tPj5OOiBHRVQgLyAod2l0aCBuZl9qd3QgY29va2llKVxuICAgIE4tLT4-QjogWWVwLCB5b3UncmUgYXV0aG9yaXplZCIsIm1lcm1haWQiOiJ7XG4gIFwidGhlbWVcIjogXCJkZWZhdWx0XCJcbn0iLCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6ZmFsc2V9)

And this diagram shows what happens when someone follows a deep link to a specific page on your website but they aren’t authenticated via Okta yet.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gICAgcGFydGljaXBhbnQgQiBhcyBCcm93c2VyXG4gICAgcGFydGljaXBhbnQgTiBhcyBOZXRsaWZ5XG4gICAgcGFydGljaXBhbnQgTyBhcyBPa3RhXG4gICAgQi0-Pk46IFJlcXVlc3QgL2RvY3MvZm9vXG4gICAgTi0tPj5COiBOb3QgYXV0aGVkLCByZWRpcmVjdCB0byBPa3RhXG4gICAgTi0tPj5COiBQbHVzIHJlZGlyZWN0X3RvIGNvb2tpZSA9IC9kb2NzL2Zvb1xuICAgIEItPj5POiBJIGNhbiBoYXogSW50ZXJuYWwgUHJvZHVjdCBEb2NzP1xuICAgIE8tPj5OOiBQT1NUIFJTMjU2IEpXVFxuICAgIE4tPj5COiBuZl9qd3QgY29va2llIChIUzI1NiBKV1QpXG4gICAgTi0-PkI6IDMwMiByZWRpcmVjdCB0byAvZG9jcy9mb28gKHJlZGlyZWN0X3RvKVxuICAgIEItPj5OOiBHRVQgL2RvY3MvZm9vICh3aXRoIG5mX2p3dCBjb29raWUpXG4gICAgTi0tPj5COiBZZXAsIHlvdSdyZSBhdXRob3JpemVkIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZSwiYXV0b1N5bmMiOnRydWUsInVwZGF0ZURpYWdyYW0iOnRydWV9)](https://mermaid-js.github.io/mermaid-live-editor/edit/#eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gICAgcGFydGljaXBhbnQgQiBhcyBCcm93c2VyXG4gICAgcGFydGljaXBhbnQgTiBhcyBOZXRsaWZ5XG4gICAgcGFydGljaXBhbnQgTyBhcyBPa3RhXG4gICAgQi0-Pk46IFJlcXVlc3QgL2RvY3MvZm9vXG4gICAgTi0tPj5COiBOb3QgYXV0aGVkLCByZWRpcmVjdCB0byBPa3RhXG4gICAgTi0tPj5COiBQbHVzIHJlZGlyZWN0X3RvIGNvb2tpZSA9IC9kb2NzL2Zvb1xuICAgIEItPj5POiBJIGNhbiBoYXogSW50ZXJuYWwgUHJvZHVjdCBEb2NzP1xuICAgIE8tPj5OOiBQT1NUIFJTMjU2IEpXVFxuICAgIE4tPj5COiBuZl9qd3QgY29va2llIChIUzI1NiBKV1QpXG4gICAgTi0-PkI6IDMwMiByZWRpcmVjdCB0byAvZG9jcy9mb28gKHJlZGlyZWN0X3RvKVxuICAgIEItPj5OOiBHRVQgL2RvY3MvZm9vICh3aXRoIG5mX2p3dCBjb29raWUpXG4gICAgTi0tPj5COiBZZXAsIHlvdSdyZSBhdXRob3JpemVkIiwibWVybWFpZCI6IntcbiAgXCJ0aGVtZVwiOiBcImRlZmF1bHRcIlxufSIsInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjp0cnVlfQ)

The redirect back to Okta happens in another Netlify function that sets the redirect_to cookie in addition to redirecting the browser to the appropriate Okta login URL.

The JWT token is signed with a secret you configure, that is also configured in the Netlify admin console. It also needs to be configured in the access control settings in Netlify. The reason it needs to be specified twice is due to the custom function we need to translate the JWT from Okta to Netlify’s format.

Finally, access is enforced using the \_redirects file, a Netlify-specific configuration file. The following (simplified) configuration illustrates this.

```text
/*   200!   Role=Everyone
/*   /.netlify/functions/login   200!
```

The first line tells Netlify we want to ensure that the user is a member of the “Everyone” role (a role we get sent to us from Okta as part of the JWT) before it will serve the content. If this rule fails, it will move on to processing the following rules. The second line tells Netlify to rewrite the request to our login function which will get the user redirected to Okta to get logged in.

## Preview site authentication

Netlify provides preview sites, in the form of `*--your-site-name.netlify.app`, where `*` is a string that we can specify to identify the unique deployment.

Because Okta can only be configured with fixed URLs to redirect back to, we have to piggy-back off the primary production site’s Okta integration to handle the auth for the infinite number of preview site URLs. This adds a fair amount of complexity to the workflow, as you can see in the diagram below, and is quite difficult to test locally in a development environment. Despite these drawbacks, the preview site feature is a huge win for using Netlify and, if you need to secure your primary site, you probably need to secure your preview site as well.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gICAgcGFydGljaXBhbnQgQiBhcyBCcm93c2VyXG4gICAgcGFydGljaXBhbnQgUCBhcyBOZXRsaWZ5IFByZXZpZXdcbiAgICBwYXJ0aWNpcGFudCBOIGFzIE5ldGxpZnkgUHJpbWFyeVxuICAgIHBhcnRpY2lwYW50IE8gYXMgT2t0YVxuICAgIEItPj5QOiBSZXF1ZXN0IC9kb2NzL2Zvb1xuICAgIFAtLT4-QjogTm90IGF1dGhlZCwgcmVkaXJlY3QgdG8gUHJpbWFyeSBsb2dpbiBmdW5jXG4gICAgUC0tPj5COiBQbHVzIHJlZGlyZWN0X3RvIGNvb2tpZSA9IC9kb2NzL2Zvb1xuICAgIEItPj5OOiBSZXF1ZXN0IGxvZ2luIGZ1bmNcbiAgICBOLS0-PkI6IE5vdCBhdXRoZWQsIHJlZGlyZWN0IHRvIE9rdGFcbiAgICBOLS0-PkI6IFBsdXMgcmVkaXJlY3RfdG8gY29va2llID0gUHJpbWFyeSBhdXRoIGZ1bmNcbiAgICBCLT4-TzogSSBjYW4gaGF6IEludGVybmFsIFByb2R1Y3QgRG9jcz9cbiAgICBPLT4-TjogUE9TVCBSUzI1NiBKV1RcbiAgICBOLS0-PkI6IG5mX2p3dCBjb29raWUgKEhTMjU2IEpXVClcbiAgICBOLS0-PkI6IDMwMiByZWRpcmVjdCB0byBQcmltYXJ5IGF1dGggZnVuYyAocmVkaXJlY3RfdG8pXG4gICAgQi0-Pk46IEdFVCBQcmltYXJ5IGF1dGggZnVuYyAod2l0aCBuZl9qd3QgY29va2llKVxuICAgIE4tLT4-QjogWWVwLCB5b3UncmUgYXV0aG9yaXplZCwgYnV0IFBPU1QgSldUIHRvIFByZXZpZXcgYXV0aCBmdW5jXG4gICAgQi0-PlA6IFBPU1QgbmZfand0IHRvIFByZXZpZXcgYXV0aCBmdW5jXG4gICAgUC0tPj5COiBuZl9qd3QgY29va2llIChIUzI1NiBKV1QpXG4gICAgUC0tPj5COiAzMDIgcmVkaXJlY3QgdG8gL2RvY3MvZm9vIChyZWRpcmVjdF90bylcbiIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjp0cnVlfQ)](https://mermaid-js.github.io/mermaid-live-editor/edit/#eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gICAgcGFydGljaXBhbnQgQiBhcyBCcm93c2VyXG4gICAgcGFydGljaXBhbnQgUCBhcyBOZXRsaWZ5IFByZXZpZXdcbiAgICBwYXJ0aWNpcGFudCBOIGFzIE5ldGxpZnkgUHJpbWFyeVxuICAgIHBhcnRpY2lwYW50IE8gYXMgT2t0YVxuICAgIEItPj5QOiBSZXF1ZXN0IC9kb2NzL2Zvb1xuICAgIFAtLT4-QjogTm90IGF1dGhlZCwgcmVkaXJlY3QgdG8gUHJpbWFyeSBsb2dpbiBmdW5jXG4gICAgUC0tPj5COiBQbHVzIHJlZGlyZWN0X3RvIGNvb2tpZSA9IC9kb2NzL2Zvb1xuICAgIEItPj5OOiBSZXF1ZXN0IGxvZ2luIGZ1bmNcbiAgICBOLS0-PkI6IE5vdCBhdXRoZWQsIHJlZGlyZWN0IHRvIE9rdGFcbiAgICBOLS0-PkI6IFBsdXMgcmVkaXJlY3RfdG8gY29va2llID0gUHJpbWFyeSBhdXRoIGZ1bmNcbiAgICBCLT4-TzogSSBjYW4gaGF6IEludGVybmFsIFByb2R1Y3QgRG9jcz9cbiAgICBPLT4-TjogUE9TVCBSUzI1NiBKV1RcbiAgICBOLS0-PkI6IG5mX2p3dCBjb29raWUgKEhTMjU2IEpXVClcbiAgICBOLS0-PkI6IDMwMiByZWRpcmVjdCB0byBQcmltYXJ5IGF1dGggZnVuYyAocmVkaXJlY3RfdG8pXG4gICAgQi0-Pk46IEdFVCBQcmltYXJ5IGF1dGggZnVuYyAod2l0aCBuZl9qd3QgY29va2llKVxuICAgIE4tLT4-QjogWWVwLCB5b3UncmUgYXV0aG9yaXplZCwgYnV0IFBPU1QgSldUIHRvIFByZXZpZXcgYXV0aCBmdW5jXG4gICAgQi0-PlA6IFBPU1QgbmZfand0IHRvIFByZXZpZXcgYXV0aCBmdW5jXG4gICAgUC0tPj5COiBuZl9qd3QgY29va2llIChIUzI1NiBKV1QpXG4gICAgUC0tPj5COiAzMDIgcmVkaXJlY3QgdG8gL2RvY3MvZm9vIChyZWRpcmVjdF90bylcbiIsIm1lcm1haWQiOiJ7XG4gIFwidGhlbWVcIjogXCJkZWZhdWx0XCJcbn0iLCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6dHJ1ZX0)
